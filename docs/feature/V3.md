# V3: Stability & Security

This document defines the stability and security roadmap for Midnight Invoice, focusing on production hardening, compliance, and operational excellence.

## Goals

| Priority | Goal |
|----------|------|
| **P0** | Zero data breaches, no unauthorized access |
| **P1** | 99.9% uptime SLA for paid tiers |
| **P2** | < 200ms p95 API response time |
| **P3** | Full audit trail for compliance |

---

## Security

### Authentication Hardening

#### Two-Factor Authentication (2FA)

- [ ] TOTP-based 2FA via authenticator apps (Google Authenticator, Authy)
- [ ] Recovery codes (one-time use, 10 codes generated)
- [ ] Enforce 2FA for team admins/owners (configurable policy)
- [ ] Remember trusted devices for 30 days

#### Session Management

- [ ] Secure session tokens with HttpOnly, Secure, SameSite=Strict cookies
- [ ] Session timeout: 24 hours idle, 7 days absolute
- [ ] View active sessions in account settings
- [ ] Remote session revocation ("Sign out everywhere")
- [ ] Session fingerprinting (IP + User-Agent anomaly detection)

#### API Key Security

- [ ] IP allowlist per API key (optional)
- [ ] Key usage analytics (requests/day, endpoints accessed)
- [ ] Automatic key rotation reminders (email at 80 days for 90-day keys)
- [ ] Anomaly detection: alert on unusual request patterns

---

### Input Validation & Sanitization

#### Server-Side Validation

- [ ] Zod schemas for all API request bodies
- [ ] Strict Content-Type enforcement (`application/json` only)
- [ ] Request size limits: 1MB for JSON, 10MB for file uploads
- [ ] SQL injection prevention via parameterized queries (Drizzle ORM)

#### Output Encoding

- [ ] HTML entity encoding for all user-generated content
- [ ] JSON response Content-Type headers
- [ ] PDF generation: sanitize user inputs before rendering

---

### Security Headers

Implement via middleware (Hono/Express):

```typescript
// Security headers configuration
const securityHeaders = {
  'Strict-Transport-Security': 'max-age=31536000; includeSubDomains; preload',
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block',
  'Referrer-Policy': 'strict-origin-when-cross-origin',
  'Permissions-Policy': 'camera=(), microphone=(), geolocation=()',
  'Content-Security-Policy': "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' https://api.midnightinvoice.com",
};
```

---

### Data Protection

#### Encryption

| Data | At Rest | In Transit |
|------|---------|------------|
| User credentials | Argon2id hash | TLS 1.3 |
| API keys | SHA-256 hash | TLS 1.3 |
| Invoice data | Turso encryption | TLS 1.3 |
| File attachments | R2 server-side encryption | TLS 1.3 |
| Backups | AES-256-GCM | TLS 1.3 |

#### Sensitive Data Handling

- [ ] PII fields marked in schema (for GDPR export/deletion)
- [ ] No sensitive data in logs (mask emails, redact payment details)
- [ ] Secure deletion: overwrite before delete for sensitive fields

---

### Audit Logging

#### Audit Events

| Category | Events |
|----------|--------|
| **Auth** | login, logout, login_failed, password_changed, 2fa_enabled, 2fa_disabled |
| **API** | api_key_created, api_key_revoked, api_key_used |
| **Data** | invoice_created, invoice_updated, invoice_deleted, invoice_sent |
| **Team** | member_invited, member_joined, member_removed, role_changed |
| **Admin** | settings_changed, export_requested, account_deleted |

#### Audit Log Schema

```typescript
export const auditLogs = sqliteTable('audit_logs', {
  id: text('id').primaryKey(),
  userId: text('user_id').references(() => users.id),
  teamId: text('team_id').references(() => teams.id),
  action: text('action').notNull(), // e.g., 'invoice.created'
  resourceType: text('resource_type'), // e.g., 'invoice'
  resourceId: text('resource_id'),
  metadata: text('metadata', { mode: 'json' }).$type<Record<string, unknown>>(),
  ipAddress: text('ip_address'),
  userAgent: text('user_agent'),
  createdAt: text('created_at').default(sql`(CURRENT_TIMESTAMP)`).notNull(),
});
```

#### Retention

- Free tier: 30 days
- Starter: 90 days
- Pro: 1 year
- Enterprise: 7 years (configurable)

---

### Vulnerability Management

#### Dependency Scanning

- [ ] `npm audit` in CI pipeline (fail on high/critical)
- [ ] Dependabot or Renovate for automated updates
- [ ] Weekly vulnerability scan reports

#### Security Testing

- [ ] OWASP ZAP automated scans (monthly)
- [ ] Annual third-party penetration test
- [ ] Bug bounty program (future)

#### Incident Response

1. **Detection**: Automated alerts via monitoring
2. **Containment**: Revoke compromised credentials, isolate affected systems
3. **Eradication**: Patch vulnerability, rotate secrets
4. **Recovery**: Restore from backup if needed
5. **Post-mortem**: Document timeline, root cause, remediation

---

## Stability

### Observability

#### Error Monitoring

- [ ] Sentry integration for error tracking
- [ ] Source maps for production debugging
- [ ] Error grouping and deduplication
- [ ] Slack/email alerts for new errors

#### Application Metrics

| Metric | Target |
|--------|--------|
| API response time (p50) | < 50ms |
| API response time (p95) | < 200ms |
| API response time (p99) | < 500ms |
| Error rate | < 0.1% |
| Availability | 99.9% |

#### Logging

- [ ] Structured JSON logs (Pino)
- [ ] Request ID correlation across services
- [ ] Log levels: error, warn, info, debug
- [ ] Log aggregation (Axiom, Logtail, or similar)

---

### Health Checks

#### Endpoints

```typescript
// Health check endpoints
GET /health          // Basic liveness probe
GET /health/ready    // Readiness probe (includes DB check)
GET /health/detailed // Full system status (authenticated)
```

#### Readiness Checks

- [ ] Database connectivity (Turso)
- [ ] R2 storage accessibility
- [ ] External service health (Resend, WorkOS, Polar)

---

### Database Reliability

#### Backups

| Tier | Frequency | Retention |
|------|-----------|-----------|
| Starter | Daily | 7 days |
| Pro | Daily | 30 days |
| Enterprise | Hourly | 90 days |

#### Disaster Recovery

- [ ] Point-in-time recovery (Turso built-in)
- [ ] Cross-region replication for Enterprise
- [ ] Automated backup verification (weekly restore test)
- [ ] RTO: 4 hours, RPO: 1 hour

#### Migrations

- [ ] Drizzle migrations with rollback support
- [ ] Pre-deployment migration dry-run
- [ ] Zero-downtime migrations (no locking reads)
- [ ] Migration audit log

---

### Graceful Degradation

#### Circuit Breakers

External service failures should not crash the app:

| Service | Fallback Behavior |
|---------|-------------------|
| Resend (email) | Queue for retry, show "email pending" status |
| WorkOS (auth) | Allow existing sessions, block new logins |
| Polar (payments) | Cache subscription status, grace period |
| R2 (storage) | Serve cached PDFs, queue uploads |

#### Feature Flags

- [ ] LaunchDarkly or custom feature flag system
- [ ] Gradual rollout (1% → 10% → 50% → 100%)
- [ ] Kill switches for problematic features
- [ ] A/B testing infrastructure

---

### Performance

#### Caching Strategy

| Data | Cache Layer | TTL |
|------|-------------|-----|
| User session | Redis/KV | 24 hours |
| Invoice PDF | R2 + CDN | 1 hour |
| Client list | Memory | 5 minutes |
| Exchange rates | Memory | 1 hour |

#### Database Optimization

- [ ] Query analysis and indexing strategy
- [ ] Connection pooling (Turso embedded replicas)
- [ ] Read replicas for analytics queries
- [ ] Slow query logging (> 100ms)

#### Load Testing

- [ ] k6 or Artillery load tests in CI
- [ ] Baseline: 100 concurrent users
- [ ] Stress test: 10x baseline
- [ ] Spike test: sudden 50x traffic

---

### Deployment

#### Zero-Downtime Deployments

- [ ] Rolling deployments with health checks
- [ ] Blue-green deployment option
- [ ] Automatic rollback on health check failure
- [ ] Database migration coordination

#### Rollback Procedures

1. Automated rollback if error rate > 1% post-deploy
2. One-click rollback in deployment dashboard
3. Database rollback scripts for each migration
4. Feature flag kill switch as first response

---

## Compliance

### GDPR

- [x] Data export endpoint (`POST /api/gdpr/export`)
- [x] Account deletion endpoint (`DELETE /api/gdpr/account`)
- [ ] Cookie consent banner
- [ ] Privacy policy with data processing details
- [ ] Data Processing Agreement (DPA) for Enterprise

### SOC 2 Type II (Future)

- [ ] Access control policies documented
- [ ] Change management procedures
- [ ] Incident response plan
- [ ] Annual security training
- [ ] Vendor security assessments

---

## Implementation Phases

### Phase 1: Foundation (Required for Launch)

- [ ] Security headers middleware
- [ ] Input validation on all endpoints
- [ ] Audit logging for auth events
- [ ] Sentry error monitoring
- [ ] Health check endpoints
- [ ] Automated backups

### Phase 2: Hardening

- [ ] Two-factor authentication
- [ ] Session management UI
- [ ] API key IP allowlisting
- [ ] Dependency vulnerability scanning
- [ ] Load testing baseline

### Phase 3: Enterprise

- [ ] Extended audit log retention
- [ ] Cross-region replication
- [ ] SOC 2 preparation
- [ ] Custom SLA agreements
- [ ] Dedicated support channel

---

## Verification Checklist

### Security

- [ ] OWASP Top 10 review completed
- [ ] Security headers score A+ on securityheaders.com
- [ ] No secrets in codebase (GitGuardian or similar)
- [ ] All dependencies up-to-date, no critical CVEs

### Stability

- [ ] 99.9% uptime over 30 days
- [ ] p95 latency < 200ms
- [ ] Successful disaster recovery drill
- [ ] Load test passing at 100 concurrent users
